# =============================================================================
# GitLab CI/CD Pipeline for iDRAC NetBox Importer
# =============================================================================
# Simple pipeline: Build → Test → Docker → Release
# =============================================================================

variables:
  GO_VERSION: "1.22"
  CGO_ENABLED: "0"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  VERSION: ${CI_COMMIT_TAG:-dev}

stages:
  - build
  - docker
  - release

# =============================================================================
# Build and Test
# =============================================================================

build-and-test:
  stage: build
  image: golang:1.22-alpine
  before_script:
    - apk add --no-cache git make
  script:
    - echo "Building and testing..."
    - go mod download
    - go build -v ./...
    - go test ./... -v -count=1
    - |
      go build -ldflags "\
        -X main.Version=${VERSION} \
        -X main.BuildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
        -X main.GitCommit=${CI_COMMIT_SHORT_SHA}" \
        -o idrac-inventory ./cmd/idrac-inventory
    - echo "✅ Build and tests completed"
  artifacts:
    paths:
      - idrac-inventory
    expire_in: 1 day

# =============================================================================
# Docker Image
# =============================================================================

docker-build:
  stage: docker
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building Docker image..."
    - |
      docker build \
        --build-arg VERSION=${VERSION} \
        --build-arg BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
        --build-arg GIT_COMMIT=${CI_COMMIT_SHORT_SHA} \
        -t $IMAGE_NAME:$CI_COMMIT_SHORT_SHA \
        -t $IMAGE_NAME:latest \
        .
    - docker push $IMAGE_NAME:$CI_COMMIT_SHORT_SHA
    - docker push $IMAGE_NAME:latest
    - echo "✅ Docker image pushed to $IMAGE_NAME:latest"
  only:
    - main
    - tags

# Tag specific version on release
docker-tag-release:
  stage: docker
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Tagging release version..."
    - docker pull $IMAGE_NAME:$CI_COMMIT_SHORT_SHA
    - docker tag $IMAGE_NAME:$CI_COMMIT_SHORT_SHA $IMAGE_NAME:$CI_COMMIT_TAG
    - docker push $IMAGE_NAME:$CI_COMMIT_TAG
    - echo "✅ Released $IMAGE_NAME:$CI_COMMIT_TAG"
  only:
    - tags

# =============================================================================
# Release
# =============================================================================

create-release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "Creating GitLab release for $CI_COMMIT_TAG"
  release:
    tag_name: $CI_COMMIT_TAG
    description: |
      # Release $CI_COMMIT_TAG

      ## Docker Image
      ```
      docker pull $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG
      ```

      ## Usage
      ```bash
      docker run --rm \
        -e IDRAC_DEFAULT_USER=your-user \
        -e IDRAC_DEFAULT_PASS=your-pass \
        -v $(pwd)/config.yaml:/app/config.yaml \
        $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG \
        -config /app/config.yaml
      ```
  only:
    - tags
