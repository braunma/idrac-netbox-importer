# =============================================================================
# GitLab CI/CD Pipeline for iDRAC NetBox Importer
# =============================================================================

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

stages:
  - build
  - docker
  - scan

# =============================================================================
# Build and Test
# =============================================================================

build-and-test:
  stage: build
  image: golang:1.22-alpine
  before_script:
    - apk add --no-cache git
  script:
    - echo "Building and testing..."
    - go mod download
    - go build -v ./...
    - go test ./... -v
    - go build -o idrac-inventory ./cmd/idrac-inventory
    - echo "✅ Build and tests completed"
  artifacts:
    paths:
      - idrac-inventory
    expire_in: 1 day

# =============================================================================
# Docker Image
# =============================================================================

docker-build:
  stage: docker
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building Docker image..."
    - docker build -t $CI_REGISTRY_IMAGE:latest .
    - docker push $CI_REGISTRY_IMAGE:latest
    - echo "✅ Docker image pushed"
  only:
    - main

# Tag release version
docker-release:
  stage: docker
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building release image..."
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG -t $CI_REGISTRY_IMAGE:latest .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG
    - docker push $CI_REGISTRY_IMAGE:latest
    - echo "✅ Released $CI_COMMIT_TAG"
  only:
    - tags

# =============================================================================
# Run Scanner
# =============================================================================

run-scanner:
  stage: scan
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Running iDRAC inventory scanner..."
    - docker pull $CI_REGISTRY_IMAGE:latest
    - |
      docker run --rm \
        -e IDRAC_DEFAULT_USER=$IDRAC_DEFAULT_USER \
        -e IDRAC_DEFAULT_PASS=$IDRAC_DEFAULT_PASS \
        -e NETBOX_URL=$NETBOX_URL \
        -e NETBOX_TOKEN=$NETBOX_TOKEN \
        -e IDRAC_LOG_LEVEL=${IDRAC_LOG_LEVEL:-info} \
        -e IDRAC_CONCURRENCY=${IDRAC_CONCURRENCY:-10} \
        -v $CI_PROJECT_DIR/config.yaml:/app/config.yaml \
        $CI_REGISTRY_IMAGE:latest \
        -config /app/config.yaml -sync -output json > scan-results.json
    - echo "✅ Scanner completed"
    - cat scan-results.json
  artifacts:
    paths:
      - scan-results.json
    expire_in: 7 days
    reports:
      dotenv: scan-results.json
  only:
    - main
    - tags
  when: manual
