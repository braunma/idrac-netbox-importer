# =============================================================================
# GitLab CI/CD Pipeline for iDRAC NetBox Importer
# =============================================================================
default:
  tags:
    - gitlab-runner-03

stages:
  - build
  - scan

# =============================================================================
# Build and Test
# =============================================================================

build-and-test:
  stage: build
  image: golang:1.22-alpine
  before_script:
    - apk add --no-cache git
  script:
    - echo "Building and testing..."
    - go mod download
    - go build -v ./...
    - go test ./... -v
    - go build -o idrac-inventory ./cmd/idrac-inventory
    - echo "âœ… Build and tests completed"
  artifacts:
    paths:
      - idrac-inventory
      - config.yaml
    expire_in: 1 day

# =============================================================================
# Run Scanner
# =============================================================================
run-scanner:
  stage: scan
  image: alpine:3.21
  script:
    - chmod +x ./idrac-inventory
    - ./idrac-inventory -config config.yaml -sync -output json > scan-results.json
    - cat scan-results.json
  artifacts:
    paths:
      - scan-results.json
    expire_in: 7 days
  dependencies:
    - build-and-test
  when: manual
