# =============================================================================
# GitLab CI/CD Pipeline — iDRAC NetBox Importer
# =============================================================================

default:
  tags:
    - gitlab-runner-03

variables:
  RUN_TESTS: "false"
  SYNC_NETBOX: "false"
  INVENTORY_DIR: "inventory"

stages:
  - build
  - scan

# =============================================================================
# Build — compile the binary and (optionally) run the test suite
# =============================================================================

build:
  stage: build
  image: golang:1.22-alpine
  before_script:
    - apk add --no-cache git ca-certificates
    - |
      if [ -n "$CA_Chain" ]; then
        echo "--- Installing custom CA certificate ---"
        cp "$CA_Chain" /usr/local/share/ca-certificates/gitlab-custom-ca.crt
        update-ca-certificates
      fi
  script:
    - go mod download
    - |
      if [ "$RUN_TESTS" = "true" ]; then
        echo "=== Running tests ==="
        go test ./... -v
      else
        echo "=== Skipping tests (RUN_TESTS=false) ==="
      fi
    - go build -o idrac-inventory ./cmd/idrac-inventory
  artifacts:
    paths:
      - idrac-inventory
      - config.yaml
    expire_in: 1 day

# =============================================================================
# Scan + Store — scan iDRAC servers and commit inventory back into this repo
# =============================================================================

scan-and-store:
  stage: scan
  image: alpine:3.21
  dependencies:
    - build  # Fixed the dependency name here
  before_script:
    - apk add --no-cache git ca-certificates
    - |
      if [ -n "$CA_Chain" ]; then
        cp "$CA_Chain" /usr/local/share/ca-certificates/gitlab-custom-ca.crt
        update-ca-certificates
      fi
    - |
      if [ -n "$GL_TOKEN_WRITE" ]; then
        PUSH_TOKEN="$GL_TOKEN_WRITE"
      else
        PUSH_TOKEN="$CI_JOB_TOKEN"
      fi
      git remote set-url origin "https://oauth2:${PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    - git config --global safe.directory "$CI_PROJECT_DIR"
    - git fetch origin "${CI_COMMIT_REF_NAME}"
    - git checkout -B "${CI_COMMIT_REF_NAME}" "origin/${CI_COMMIT_REF_NAME}"
    - git config user.email "ci-bot@${CI_SERVER_HOST}"
    - git config user.name "GitLab CI"
  script:
    - chmod +x ./idrac-inventory
    - |
      ARGS="-config config.yaml -gitlab-repo ${CI_PROJECT_DIR} -gitlab-dir ${INVENTORY_DIR} -gitlab-branch ${CI_COMMIT_REF_NAME} -gitlab-push"
      
      if [ "$SYNC_NETBOX" = "true" ]; then
        echo "=== NetBox sync enabled ==="
        ARGS="$ARGS -sync"
      fi

      echo "=== Starting iDRAC scan ==="
      ./idrac-inventory $ARGS
  when: manual
