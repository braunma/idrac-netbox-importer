# =============================================================================
# GitLab CI/CD Pipeline for iDRAC NetBox Importer
# =============================================================================

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

stages:
  - build
  - docker
  - scan

# =============================================================================
# Build and Test
# =============================================================================

build-and-test:
  stage: build
  image: golang:1.22-alpine
  before_script:
    - apk add --no-cache git
  script:
    - echo "Building and testing..."
    - go mod download
    - go build -v ./...
    - go test ./... -v
    - go build -o idrac-inventory ./cmd/idrac-inventory
    - echo "✅ Build and tests completed"
  artifacts:
    paths:
      - idrac-inventory
      - config.yaml
    expire_in: 1 day

# =============================================================================
# Docker Image
# =============================================================================

docker-build:
  stage: docker
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building Docker image..."
    - docker build -t $CI_REGISTRY_IMAGE:latest .
    - docker push $CI_REGISTRY_IMAGE:latest
    - echo "✅ Docker image pushed"
  only:
    - main

# Tag release version
docker-release:
  stage: docker
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building release image..."
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG -t $CI_REGISTRY_IMAGE:latest .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG
    - docker push $CI_REGISTRY_IMAGE:latest
    - echo "✅ Released $CI_COMMIT_TAG"
  only:
    - tags

# =============================================================================
# Run Scanner
# =============================================================================

run-scanner:
  stage: scan
  image: alpine:3.21
  before_script:
    - apk add --no-cache ca-certificates tzdata
  script:
    - echo "Running iDRAC inventory scanner..."
    - chmod +x ./idrac-inventory
    - ./idrac-inventory -config config.yaml -sync -output json > scan-results.json
    - echo "✅ Scanner completed"
    - cat scan-results.json
  artifacts:
    paths:
      - scan-results.json
    expire_in: 7 days
  dependencies:
    - build-and-test
  only:
    - main
    - tags
  when: manual
